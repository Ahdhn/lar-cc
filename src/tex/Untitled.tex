from larlib import *

filename = "/Users/paoluzzi/Documents/RICERCA/vadim/LAST/SysML/images/appendix/scann01.svg"
lines = svg2lines(filename)
VIEW(STRUCT(AA(POLYLINE)(lines)))
    
V,FV,EV = larFromLines(lines)
VIEW(EXPLODE(1.2,1.2,1)(MKPOLS((V,EV)) + AA(MK)(V)))

VV = AA(LIST)(range(len(V)))
submodel = STRUCT(MKPOLS((V,EV)))
VIEW(larModelNumbering(1,1,1)(V,[VV,EV,FV[:-1]],submodel,0.3))

verts,faces,edges = polyline2lar([[ V[v] for v in FV[-1] ]])
VIEW(STRUCT(MKPOLS((verts,edges))))

p1 = [11,3,4,9,10,-1,0,11]
p2 = [5,6,1,-8,9,12,5]
p3 = [3,4,9,12,5,6,1,0,2,-3]

def neg(poly):
	return [k for k,p in enumerate(poly) if p<0]

V1 = [V[abs(v)]+[0.01] for v in p1]
V2 = [V[abs(v)]+[0.0] for v in p2]
V3 = [V[abs(v)]+[-0.01] for v in p3]

VIEW(STRUCT(AA(POLYLINE)([V1,V2,V3])))

def signature(V,symbolDict,poly):
	vect = [VECTDIFF((V[u],V[v])) for u,v in zip(poly[:-1],poly[1:])]
	sizes = [VECTNORM(v) for v in vect]
	cvect = AA(UNITVECT)(vect+[vect[0]])
	vnormal = AA(VECTDIFF)(zip(cvect[:-1], cvect[1:]))
	angles = [math.atan2(y,x)*180/PI for x,y in vnormal]
	keys = AA(str)(eval(vcode((CAT(zip(sizes,angles))))))
	vals = AA(C(ADD)(65))(range(len(keys)))
	last = len(symbolDict)
	for k,key in enumerate(keys): 
		if symbolDict[key] == []:
			last += 1
			symbolDict[key] = [chr(64+last)]
	v = neg(poly)[0]
	symbolDict[keys[v+1]] = ["~"]
	sign = CAT([symbolDict[key] for key in keys])
	sign = "".join(sign)
	first = min(sign)
	twoSubStrings = sign.split(first)
	sign = first + twoSubStrings[1] + twoSubStrings[0]
	return symbolDict,"".join(sign)

symbolDict = defaultdict(list)
sign1 = signature(V,symbolDict,p1)
sign2 = signature(V,symbolDict,p2)
sign3 = signature(V,symbolDict,p3)

print "\n",sign1[1],"\n",sign2[1],"\n",sign3[1]


