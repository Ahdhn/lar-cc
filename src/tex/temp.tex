import sys;sys.path.insert(0, 'lib/py/')
from bool2 import *
sys.path.insert(0, 'test/py/larcc/')
from test11 import *

C2 = csr_matrix((len(FV),1))
for i in [21,16,23,22, 2,3,4, 9,28,5]: C2[i,0] = 1
BD = boundary(FV,EV)
C1 = BD * C2
C_1 = [i for i in range(len(EV)) if ABS(C1[i,0]) == 1 ]
C_2 = [i for i in range(len(FV)) if C2[i,0] == 1 ]

VIEW(EXPLODE(1.2,1.2,1)(MKPOLS((V,[EV[k] for k in C_1] + [FV[k] for k in C_2]))))

def boundaryCicles(edgeBoundary,EV):
    verts2edges = defaultdict(list)
    for e in edgeBoundary:
        verts2edges[EV[e][0]] += [e]
        verts2edges[EV[e][1]] += [e]
    cycles = []
    cbe = copy.copy(edgeBoundary)
    while cbe != []:
        e = cbe[0]
        v = EV[e][0]
        cycle = []
        while True:
            cycle += [(e,v)]
            e = list(set(verts2edges[v]).difference([e]))[0]
            cbe.remove(e)
            v = list(set(EV[e]).difference([v]))[0]
            if (e,v)==cycle[0]:
                break
        n = len(cycle)
        cycles += [[e if EV[e]==[cycle[k%n -1][1],cycle[k][1]] else -e 
            for k,(e,v) in enumerate(cycle)]]
    return cycles
    
def cycles2permutation(cycles):
    next = []
    for cycle in cycles:
        next += zip(AA(ABS)(cycle),AA(ABS)(cycle[1:]+[cycle[0]]))
    next = dict(next)
    sign = dict([[ABS(edge),SIGN(edge)] for cycle in cycles for edge in cycle])
    return sign,next

sign,next = cycles2permutation(boundaryCicles(C_1, EV))
print "\nsign =",sign
print "\nnext =",next,"\n"


def joinCycles(perm1,perm2):
	print "cycle permutation 1",perm1
	print "cycle permutation 2",perm2


#= ciclo corrente ===================================
C2 = csr_matrix((len(FV),1))
for i in [21,16,23,22]: C2[i,0] = 1
BD = boundary(FV,EV)
C1 = BD * C2
C_1a = [i for i in range(len(EV)) if ABS(C1[i,0]) == 1 ]
C_2a = [i for i in range(len(FV)) if C2[i,0] == 1 ]

#= nuova faccia ===================================
C2 = csr_matrix((len(FV),1))
for i in [33]: C2[i,0] = 1
BD = boundary(FV,EV)
C1 = BD * C2
C_1b = [i for i in range(len(EV)) if ABS(C1[i,0]) == 1 ]
C_2b = [i for i in range(len(FV)) if C2[i,0] == 1 ]
  
#= join di faccia e ciclo ===================================
perm1 = cycles2permutation(boundaryCicles(C_1a, EV))
perm2 = cycles2permutation(boundaryCicles(C_1b, EV))
joinCycles(perm1,perm2)

