names = [ 
			"piano",
            "level",
			[
				[
					"nord",
                    "ala",
					[
						[
							"destra",
                            "zona",
							[
								["room_1", "room", [] ],
								["room_2", "room", [] ],
								["room_3", "room", [] ],
								["room_4", "room", [] ],
								["room_5", "room", [] ],
								["room_6", "room", [] ],
								["room_7", "room", [] ],
								["room_8", "room", [] ],
								["room_9", "room", [] ]
							] 
						],
           				[
           					"sinistra",
                            "zona",
           					[
								["room_1", "room", [] ],
								["room_2", "room", [] ],
								["room_3", "room", [] ],
								["room_4", "room", [] ],
								["room_5", "room", [] ],
								["room_6", "room", [] ],
								["room_7", "room", [] ],
								["room_8", "room", [] ],
								["room_9", "room", [] ]
           					]
           				],
           				[
           					"connettivo",
                            "zona",
           					[
           						["room_1", "room", [] ]
           					]
           				],
           				[
           					"ascensore",
                            "zona",
           					[
           						["room_1", "room", [] ],
           						["room_2", "room", [] ]
           					]
           				],
          				[
          					"scale",
                            "zona",
          					[
          						["room_1", "room", [] ]
          					]
          				],
           				[
           					"servizi",
                            "zona",
           					[
           						["room_1", "room", [] ],
           						["room_2", "room", [] ],
           						["room_3", "room", [] ]
           					]												
						]
					]
				],
				[
					"sud",
                    "ala",
					[
						[
							"destra",
                            "zona",
							[
								["room_1", "room", [] ],
								["room_2", "room", [] ],
								["room_3", "room", [] ],
								["room_4", "room", [] ],
								["room_5", "room", [] ],
								["room_6", "room", [] ],
								["room_7", "room", [] ],
								["room_8", "room", [] ],
								["room_9", "room", [] ],
								["room_10", "room", [] ],
								["room_11", "room", [] ]
							] 
						],
           				[
           					"sinistra",
                            "zona",
           					[
								["room_1", "room", [] ],
								["room_2", "room", [] ],
								["room_3", "room", [] ],
								["room_4", "room", [] ],
								["room_5", "room", [] ],
								["room_6", "room", [] ],
								["room_7", "room", [] ],
								["room_8", "room", [] ],
								["room_9", "room", [] ]
           					]
           				],
           				[
           					"connettivo",
                            "zona",
           					[
           						["room_1", "room", [] ]
           					]
           				],
           				[
           					"ascensore",
                            "zona",
           					[
           						["room_1", "room", [] ]
           					]
           				],
          				[
          					"scale",
                            "zona",
          					[
          						["room_1", "room", [] ]
          					]
          				],
           				[
           					"servizi",
                            "zona",
           					[
           						["room_1", "room", [] ],
           						["room_2", "room", [] ],
           						["room_3", "room", [] ],
           						["room_4", "room", [] ],
           						["room_5", "room", [] ]
							]												
						]
					]
				],
				[
					"est",
                    "ala",
					[
						[
							"destra",
                            "zona",
							[
								["room_1", "room", [] ],
								["room_2", "room", [] ],
								["room_3", "room", [] ],
								["room_4", "room", [] ],
								["room_5", "room", [] ],
								["room_6", "room", [] ],
								["room_7", "room", [] ],
								["room_8", "room", [] ],
								["room_9", "room", [] ],
								["room_10", "room", [] ]
							] 
						],
           				[
           					"sinistra",
                            "zona",
           					[
								["room_1", "room", [] ],
								["room_2", "room", [] ],
								["room_3", "room", [] ],
								["room_4", "room", [] ],
								["room_5", "room", [] ],
								["room_6", "room", [] ],
								["room_7", "room", [] ],
								["room_8", "room", [] ]
           					]
           				],
           				[
           					"connettivo",
                            "zona",
           					[
								["room_1", "room", [] ]
           					]
           				],
           				[
           					"ascensore",
                            "zona",
           					[
								["room_1", "room", [] ]
           					]
           				],
          				[
          					"scale",
                            "zona",
          					[
								["room_1", "room", [] ]
          					]
          				],
           				[
           					"servizi",
                            "zona",
           					[
								["room_1", "room", [] ],
								["room_2", "room", [] ]
           					]												
						]
					]
				],
				[
					"ovest",
                    "ala",
					[
						[
							"destra",
                            "zona",
							[
								["room_1", "room",  [] ],
								["room_2", "room",  [] ],
								["room_3", "room",  [] ],
								["room_4", "room",  [] ],
								["room_5", "room",  [] ],
								["room_6", "room",  [] ],
								["room_7", "room",  [] ],
								["room_8", "room",  [] ],
								["room_9", "room",  [] ],
								["room_10", "room", [] ],
								["room_11", "room", [] ],
								["room_12", "room", [] ],
								["room_13", "room", [] ],
								["room_14", "room", [] ]
							] 
						],
           				[
           					"sinistra",
                            "zona",
           					[
								["room_1", "room",  [] ],
								["room_2", "room",  [] ],
								["room_3", "room",  [] ],
								["room_4", "room",  [] ],
								["room_5", "room",  [] ],
								["room_6", "room",  [] ],
								["room_7", "room",  [] ],
								["room_8", "room",  [] ],
								["room_9", "room",  [] ],
								["room_10", "room", [] ],
								["room_11", "room", [] ],
								["room_12", "room", [] ]
           					]
           				],
           				[
           					"connettivo",
                            "zona",
           					[
								["room_1", "room",  [] ]
           					]
           				],
           				[
           					"ascensore",
                            "zona",
           					[
								["room_1", "room",  [] ],
								["room_2", "room",  [] ]
           					]
           				],
          				[
          					"scale",
                            "zona",
                         
          					[
								["room_1", "room",  [] ]
          					]
          				],
           				[
           					"servizi",
                            "zona",
           					[
								["room_1", "room",  [] ],
								["room_2", "room",  [] ]

           					]												
						]
					]
				],
				[
					"centro",
                    "ala",
					[
           				[
           					"connettivo",
                            "zona",
           					[
								["room_1", "room",  [] ]
           					]
           				],
          				[
          					"scale",
                            "zona",
          					[
								["room_1", "room",  [] ],
								["room_2", "room",  [] ]
          					]
          				]
					]
				]
			]
		]

def codex(pair, parentName, out):
	newName = parentName + "_" + pair[0]
	out += [ (newName, pair[1]) ]
	pair.append(newName)
	if len(pair[2]) > 0:
		for element in pair[2]:
			codex(element, pair[-1],out)
#codex(names, "building")

import copy
floors = [ copy.deepcopy(names) for k in range(6) ]
for k,floor in enumerate(floors):
    floors[k] = [floor[0]+"_"+str(k), floor[1], floor[2]]

building = [ "sogei","building", floors]
nomi_classi = []
codex(building, "torre", nomi_classi)




##############################################



""" import modules from larcc/lib """
import sys
sys.path.insert(0, 'lib/py/')
from hijson import *

scaleFactor = 83.333

filename = "test/py/inters/plan.svg"
larModel = svg2lar(filename)
larModel = larApply(s(scaleFactor,scaleFactor))(larModel)
V,FV,EV = larModel
FV[2] += FV[71]      # for now :o)

""" Assembling floor layout generation """
""" Visualization of cell numbering in a 2D complex """
VV = AA(LIST)(range(len(V)))
submodel = STRUCT(MKPOLS((V,EV)))
VIEW(larModelNumbering(1,1,1)(V,[VV,EV,FV[:-1]],submodel,2.5))

FE = crossRelation(FV,EV)


##############################################


data = [[[28,99,41,63,86,102,5,4,105],
 [83,81,49,80,23,98,91,13,53],
 [12],
 [77, 48],
 [19],
 [95, 47, 31]],
[[8, 14, 27, 36, 37, 44, 62, 69, 75, 85, 94],
 [1, 24, 40, 50, 60, 61, 65, 87, 92],
 [25],
 [3],
 [66],
 [10, 11, 52, 89, 108]],
[[20, 21, 30, 67, 70, 88, 90, 96, 107, 110],
 [0, 51, 58, 59, 68, 78, 84, 93],
 [29],
 [56],
 [34],
 [16, 76]],
[[7, 9, 17, 18, 35, 38, 39, 46, 64, 79, 100, 101, 103, 111],
 [22, 32, 33, 42, 45, 55, 73, 74, 97, 106, 109, 112],
 [6],
 [43, 57],
 [82],
 [104, 54]],
[[],[],[2],[],[15, 26]]]


cellHierarchy = data 

###############################################



def to_pair (item):
  if type(item) is int:
    origin = tuple(AA(min)(TRANS([V[v] for v in FV[item]])))
    pair = (origin,[item])
    return pair
  else:
    items =[x for x in item if type(x) is not list or x !=[]]
    pairs = AA(to_pair)(items)
    origins = AA(S1)(pairs)
    origin = (min(AA(S1)(origins)), min(AA(S2)(origins)))
    pair = (origin, pairs)
    return pair
    
pair = to_pair(cellHierarchy)

def to_struct (params):
    p_origin, parent = params
    c_origin, c_pairs = parent
    cell = c_pairs[0]
    origin = VECTDIFF([c_origin, p_origin])
    if type(cell) is int:        
        c_x,c_y = c_origin
        verts = larTranslate([-c_x,-c_y])([V[v] for v in FV[cell]])
        fvDict = dict([(v,k) for k,v in enumerate(FV[cell])])
        model = (verts,[range(len(verts))],[[fvDict[v] for v in EV[e]] for e in FE[cell]])
        return Struct([t(*origin), model])
    else:
        return Struct([t(*origin)] + AA(to_struct)(DISTL([c_origin, c_pairs])) )


piano_2D = to_struct([pair[0], pair])
W,WF,WE = struct2lar(piano_2D)
VIEW(EXPLODE(1.2,1.2,1.2)(MKPOLS( (W,WE) )))

piano = embedStruct(1)(piano_2D)


###############################################



torre = Struct( CAT([[ piano.clone(), t(0,0,4) ] for k in range(6)]))
W,WF,WE = struct2lar(torre)
VIEW(EXPLODE(1.2,1.2,1.2)(MKPOLS( (W,WE) )))




###############################################



def traverseStruct(obj,out):
    for k,element in enumerate(obj.body):
        if isinstance(element,Struct): 
            out += [id(element)]
            traverseStruct(element, out)
    return out

out_structs = traverseStruct(torre,[id(torre)])

import ctypes

def id2obj(objId):
	return ctypes.cast(objId, ctypes.py_object).value


for ID,(name,category) in zip(out_structs,nomi_classi):
    element = id2obj(ID)
    element.name = name
    element.category = category



###############################################



from hijson import *
from iot3d import *
printStruct2GeoJson("./",torre)






